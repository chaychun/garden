---
export const prerender = false;

import PreviewWidget from "@/components/widgets/PreviewWidget.astro";
import HomeLayout from "@/layouts/HomeLayout.astro";
import { getCollection } from "astro:content";

const works = await getCollection("works");

const allItems = works
	.filter((w) => (w.data.types ?? []).includes("interaction"))
	.sort(
		(a, b) =>
			b.data.lastUpdatedDate.getTime() - a.data.lastUpdatedDate.getTime(),
	);

const urlParams = new URLSearchParams(
	import.meta.env.SSR ? "" : window.location.search,
);
const initialFilterParam = urlParams.get("filter") || "all";
const filterName =
	initialFilterParam.charAt(0).toUpperCase() + initialFilterParam.slice(1);
---

<HomeLayout title={`${filterName} | Chayut`} scrollAreaId="main-scroll">
	{
		allItems.map((item) => {
			const itemDate = item.data.lastUpdatedDate;
			const formattedDate = itemDate.toLocaleDateString("en-US", {
				year: "numeric",
				month: "short",
				day: "numeric",
			});

			return (
				<PreviewWidget
					{...item.data}
					id={item.id}
					date={formattedDate}
					bgImage={item.data.bgImage || ""}
					previewVideo={item.data.previewVideo ?? ""}
					data-type="interactions"
					style="opacity: 0; transform: translateY(10px); visibility: hidden;"
				/>
			);
		})
	}
</HomeLayout>

<script>
	import { useFilterStore, type FilterType } from "@/lib/stores/filterStore";
	import { animate, stagger } from "motion";

	function updateTitle(filter: string) {
		const filterName = filter.charAt(0).toUpperCase() + filter.slice(1);
		document.title = `${filterName} | Chayut`;
	}

	function setWidgetVisibility(filter: string) {
		const allWidgets = document.querySelectorAll("[data-type]");
		const visibleWidgets: HTMLElement[] = [];

		allWidgets.forEach((widget) => {
			const widgetType = widget.getAttribute("data-type");

			if (filter === "all" || filter === widgetType) {
				widget.classList.remove("hidden");
				(widget as HTMLElement).style.visibility = "visible";
				visibleWidgets.push(widget as HTMLElement);
			} else {
				widget.classList.add("hidden");
			}
		});

		return visibleWidgets;
	}

	function animateWidgets(widgets: Element[]) {
		if (widgets.length === 0) return;
		const animation = animate(
			widgets,
			{
				opacity: [0, 1],
				y: [10, 0],
			},
			{
				duration: 0.3,
				ease: "easeOut",
				delay: stagger(0.08),
			},
		);
	}

	async function animateFilterChange(filter: string) {
		const allWidgets = document.querySelectorAll("[data-type]");

		const exitAnimation = animate(
			allWidgets,
			{
				opacity: [1, 0],
				y: [0, 10],
			},
			{
				duration: 0.2,
				ease: "easeOut",
				delay: stagger(0.05),
			},
		);

		await exitAnimation.finished;

		const visibleWidgets = setWidgetVisibility(filter);
		animateWidgets(visibleWidgets);
	}

	function handleFilterChange(event: CustomEvent<{ filter: string }>) {
		const filter = event.detail.filter;
		updateTitle(filter);
		animateFilterChange(filter);
	}

	function animateInitialLoad(filter: string) {
		const visibleWidgets = setWidgetVisibility(filter);
		animateWidgets(visibleWidgets);
	}

	function initializeFiltering() {
		const urlParams = new URLSearchParams(window.location.search);
		const initialFilterParam = urlParams.get("filter") || "all";

		updateTitle(initialFilterParam);
		animateInitialLoad(initialFilterParam);

		const storeFilter = (
			initialFilterParam === "all"
				? "All"
				: initialFilterParam.charAt(0).toUpperCase() +
					initialFilterParam.slice(1)
		) as FilterType;
		useFilterStore.getState().setActiveFilter(storeFilter);

		document.addEventListener(
			"filter-changed",
			handleFilterChange as EventListener,
		);
	}

	function cleanup() {
		document.removeEventListener(
			"filter-changed",
			handleFilterChange as EventListener,
		);
	}

	document.addEventListener("astro:page-load", initializeFiltering);
	document.addEventListener("astro:before-swap", cleanup);
</script>
