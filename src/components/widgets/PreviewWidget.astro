---
import Widget from "@/components/widgets/Widget.astro";
import ImageSwapMedia from "@/components/widgets/image-swap-media";
import { getCldImageUrl, getCldVideoUrl } from "astro-cloudinary/helpers";

interface VideoVariantProps {
	type: "video";
	previewVideo: string;
	previewWidth?: number;
}

interface ImageVariantProps {
	type: "image";
	previewImage: string;
	alt?: string;
	previewWidth?: number;
}

interface ImageSwapVariantProps {
	type: "image-swap";
	previewImages: string[];
	alt?: string;
	aspect?: "portrait" | "landscape" | "square";
	intervalMs?: number;
	previewWidth?: number;
}

type VariantProps =
	| VideoVariantProps
	| ImageVariantProps
	| ImageSwapVariantProps;

interface Props {
	title: string;
	href: string;
	bgImage: string;
	variant: VariantProps;
	[key: string]: any;
}

const { title, href, bgImage, variant, ...rest } = Astro.props as Props;

const bgImageUrl = getCldImageUrl({
	src: bgImage,
	width: 600,
	format: "auto",
});

const clampedWidth = (() => {
	const vw = variant.previewWidth;
	if (typeof vw !== "number" || Number.isNaN(vw) || vw <= 0) return 0.9;
	return Math.max(0, Math.min(1, vw));
})();
const previewWidthCss = `${(clampedWidth * 100).toFixed(4)}%`;
---

<Widget
	class:list={[
		"flex max-w-[528px] flex-col gap-3 md:justify-between",
		"mb-12 md:mb-0",
	]}
	{...rest}
>
	<a
		href={href}
		class="block"
		aria-label={`View ${title}`}
		data-cursor-hover
		data-cursor-title={title}
	>
		<div
			class="group relative flex aspect-4/5 w-full items-center justify-center"
			style={{
				backgroundImage: `url(${bgImageUrl})`,
				backgroundSize: "cover",
			}}
		>
			{
				variant.type === "video" && (
					<video
						src={getCldVideoUrl({ src: variant.previewVideo })}
						loop
						muted
						autoplay
						preload="metadata"
						playsinline
						class="relative z-10 h-auto"
						style={{ width: previewWidthCss }}
					/>
				)
			}

			{
				variant.type === "image" && (
					<img
						src={getCldImageUrl({
							src: variant.previewImage,
							width: 600,
							format: "auto",
						})}
						alt={variant.alt || title}
						loading="lazy"
						decoding="async"
						class="relative z-10 h-auto object-contain"
						style={{ width: previewWidthCss }}
					/>
				)
			}

			{
				variant.type === "image-swap" && (
					<ImageSwapMedia
						client:load
						images={variant.previewImages}
						alt={variant.alt || title}
						intervalMs={variant.intervalMs}
						containerClassName="absolute inset-0 h-full w-full"
						className="relative z-10 h-auto object-contain"
						imageStyle={{ width: previewWidthCss }}
					/>
				)
			}
		</div>
	</a>
</Widget>
