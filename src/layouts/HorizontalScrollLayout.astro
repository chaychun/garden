---
import BaseLayout from "./BaseLayout.astro";
import HomeSidebar from "@/components/nav/HomeSidebar";
import HomeMobileTopBar from "@/components/nav/HomeMobileTopBar";

interface Props {
	title: string;
	sidebar: string;
	scrollAreaId?: string;
}

const { title, sidebar, scrollAreaId = "main-scroll" } = Astro.props;
---

<BaseLayout title={title}>
	<div class="bg-base-50 min-h-screen">
		{
			sidebar === "home" && (
				<>
					<div class="fixed top-0 right-0 left-0 z-40 block md:hidden">
						<HomeMobileTopBar client:visible />
					</div>
				</>
			)
		}
		<div class="w-full pt-[64px] md:pt-0">
			<div
				class="md:flex md:h-dvh md:overflow-x-auto md:overflow-y-hidden"
				id="scroll-container"
				data-scroll-area-id={scrollAreaId}
			>
				{
					sidebar === "home" && (
						<div class="hidden md:sticky md:left-0 md:z-30 md:block md:flex-shrink-0">
							<HomeSidebar client:visible scrollAreaId={scrollAreaId} />
						</div>
					)
				}
				<div
					class="mx-auto flex max-w-[528px] flex-col md:max-w-none md:flex-row"
				>
					<slot />
				</div>
			</div>
		</div>

		<script>
			import {
				setupHorizontalScrollSmoothing,
				setupVerticalScrollSmoothing,
			} from "@/lib/scroll-smoothing";

			let currentCleanup: (() => void) | null = null;
			let resizeTimeout: number | null = null;

			function setupScrollSmoothing() {
				if (currentCleanup) {
					currentCleanup();
					currentCleanup = null;
				}

				const isDesktop = window.innerWidth >= 768;

				if (isDesktop) {
					currentCleanup = setupHorizontalScrollSmoothing("#scroll-container");
				} else {
					currentCleanup = setupVerticalScrollSmoothing();
				}
			}

			function handleResize() {
				if (resizeTimeout) {
					clearTimeout(resizeTimeout);
				}
				resizeTimeout = window.setTimeout(() => {
					setupScrollSmoothing();
					resizeTimeout = null;
				}, 150);
			}

			if (document.readyState === "loading") {
				document.addEventListener("DOMContentLoaded", setupScrollSmoothing);
			} else {
				setupScrollSmoothing();
			}

			document.addEventListener("astro:page-load", setupScrollSmoothing);

			window.addEventListener("resize", handleResize);

			window.addEventListener("beforeunload", () => {
				if (currentCleanup) {
					currentCleanup();
					currentCleanup = null;
				}
				if (resizeTimeout) {
					clearTimeout(resizeTimeout);
				}
			});
		</script>
	</div>
</BaseLayout>
